name: Release (Plogon)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true  # you have Glamourer.Api as a submodule

      - name: Setup .NET (Plogon uses .NET 8)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Prepare Plogon workspace
        run: |
          set -e
          mkdir -p manifests/stable/EorzeaLink
          mkdir -p output work artifacts

          # write manifest.toml with current commit
          cat > manifests/stable/EorzeaLink/manifest.toml <<'EOF'
          [plugin]
          repository = "https://github.com/FuzzyCore/EorzeaLink.git"
          commit = "${{ github.sha }}"
          owners = [ "FuzzyCore" ]
          changelog = '''
          Automated build.
          '''
          EOF

          # optional icon (if present in repo)
          if [ -f EorzeaLink/icon.png ]; then
            cp EorzeaLink/icon.png manifests/stable/EorzeaLink/icon.png
          fi

      - name: Clone Plogon
        run: git clone https://github.com/goatcorp/Plogon.git

      - name: Build with Plogon
        working-directory: Plogon/Plogon
        run: |
          dotnet run -- \
            --manifest-folder="../../manifests" \
            --output-folder="../../output" \
            --work-folder="../../work" \
            --static-folder="static" \
            --artifact-folder="../../artifacts" \
            --mode=Development --build-all

      # Plogon drops built zips under artifacts/<PluginName>/
      - name: Show artifacts
        run: find artifacts -maxdepth 2 -type f -iname "*.zip" -print

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/**/*.zip
          generate_release_notes: true